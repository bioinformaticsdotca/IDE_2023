# Background

The primary objective of the Module 5 lab will be to provide a practical
overview of cgMLST, a genome-based typing method widely adopted in
bacterial genomic surveillance networks across the globe. The widespread
adoption of cgMLST is due in large part to recent advances in
high-throughput sequencing, which have enabled the routine adoption of
whole genome sequencing in microbial surveillance, coupled with the
development of efficient computational algorithms to perform Multi Locus
Sequence Typing at genome scales. 

The implementation of cgMLST by the PulseNet International network for
foodborne outbreak surveillance has made it possible for WGS data to be
used as evidence in public health investigations. Here, you will work
with cgMLST data to conduct a retrospective analysis on a dataset that
includes a number of possible Salmonella enterica outbreaks. Salmonella,
which is primarily transmitted to humans through the consumption of
contaminated foods, is one of the leading enteric pathogens in Canada
and across the globe and was the first pathogen for which comprehensive
genomic surveillance was implemented in Canada.

The outbreak dataset consists of WGS data from isolates recovered from
samples collected from a diverse range of geographical regions,
environments, and timelines that can be dated back to the early 2000s.
Curating this outbreak dataset involved querying a global bacterial
genomic surveillance database (GenomeTrakr) and PubMed queries to
identify peer-reviewed publications that reported retrospective genomic
analysis of Salmonella outbreaks. In this exercise, you will use a
custom workflow written in the R language for statistical computing that
includes modules that perform various steps in genomic epidemiologic
analysis using cgMLST data. Your challenge will be to leverage the tools
and data at your disposal to establish high quality cgMLST profiles that
can be used to infer ancestral relationships between the various
Salmonella isolates, and to explore patterns in the data in order to
synthesise possible interpretations based on all available genomic and
epidemiological data.

To start, you will be provided with pre-computed cgMLST allele calls
generated by chewBBACA (Silva et al. 2018, PMID: 29543149), using a
Salmonella core genome scheme based on 3,000 loci. Minor filtering has
been performed to remove loci with zero informative alleles across the
entire dataset. The following code template was used to call chewBBACA
on a set of Salmonella genomes consolidated in a single directory called
`/path/to/my_genomes`:

``` bash
chewBBACA.py AlleleCall -i /path/to/my_genomes/ -g /path/to/cgMLST_scheme/ -o /path/to/results
```

## Learning Objectives

-   Understanding the significance of metrics used for MLST-based
    quality control
-   Explaining the difference between core, accessory and pan-genome
    loci and their use in MLST analysis
-   Building dendrograms from MLST data
-   Familiarisation with the ggtree R library for tree visualization
-   Exploring the clonality of bacterial populations in the context of
    bactertial foodborne outbreaks
-   Leveraging epidemiological data by linking it to MLST-based
    dendrograms to explain molecular differences and infer possible
    outbreak scenarios

## Analysis Dataset

The dataset for Module 5 lab has been uploaded to Google Sheets:

1.  [Metadata](https://docs.google.com/spreadsheets/d/12gvH6U5pwj8QK-Ui3lOIYOm_X-69A2IE0cbctaEzY5E/edit?usp=sharing#gid=1448009352)
2.  [cgMLST
    data](https://docs.google.com/spreadsheets/d/12gvH6U5pwj8QK-Ui3lOIYOm_X-69A2IE0cbctaEzY5E/edit?usp=sharing#gid=8240612)

# Getting Started

Let’s begin by loading all R packages and helper scripts required to run
all the code in this lab.

> <u>Every time you begin a new R session, you must reload all the
> packages and scripts!</u>

``` r
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(here))
suppressPackageStartupMessages(library(treedataverse))
suppressPackageStartupMessages(library(plotly))
suppressPackageStartupMessages(library(ggnewscale))
suppressPackageStartupMessages(library(ComplexHeatmap))
suppressPackageStartupMessages(library(circlize))
suppressPackageStartupMessages(library(randomcoloR))
suppressPackageStartupMessages(library(RColorBrewer))
suppressPackageStartupMessages(library(phangorn))
source(here("src/mlst_helper.R"))
source(here("src/ggtree_helper.R"))
source(here("src/cluster_helper.R"))
```

Next, read the cgMLST data and metadata into memory using `fread()` from
the `data.table` package.

``` r
# data paths
metadata_path <- here("data/senterica_metadata_full.tsv")
cgmlst_path <- here("data/senterica_cgMLST_full.tsv")
# read file
meta <- fread(metadata_path, sep = "\t")
cgmlst <- fread(cgmlst_path, sep = "\t")
```

# cgMLST QC

Before proceeding any further, you will first need to evaluate cgMLST
data quality. A number of quality criteria will be defined to determine
whether the properties of the allele profiles meet quality standards.
Incomplete genome assembly and reference bias during MLST scheme
construction can introduce significant levels of missing information in
MLST data in the form of unassigned alleles at various loci. Hence, care
must be taken to avoid comparisons that include loci and genomes with
excessive numbers of unassigned alleles that could reduce the precision
of genetic similarity calculations to be used for generating dendrograms
for inferring relationships between the various genomes in the dataset.
Below, you will conduct a series of steps to compute the frequency of
unassigned alleles across each locus (i.e. columns) and genome
(i.e. rows), which will inform the identification of poor quality
loci/genomes that may need to be flagged for removal from downstream
analyses.

> <u>Editable parts of the code have been highlighted in the code
> chunks.</u> You are highly encouraged to adjust them to observe how
> different parameters affect the outcome.

## Locus Quality

``` r
# use compute_lc helper function to compute 
# allele assignment rate (completeness) 
# across all loci
loci_completeness <- compute_lc(cgmlst)
# write to file
write.table(loci_completeness, here("cgmlst_loci_quality.stats.tsv"),
            quote = F, row.names = F, sep = "\t")
# print summary statistics for locus completeness
summary(loci_completeness)
```

    ##     locus           valid_alleles   missing_alleles    completeness    
    ##  Length:2952        Min.   :  4.0   Min.   :  0.000   Min.   :  2.198  
    ##  Class :character   1st Qu.:181.0   1st Qu.:  0.000   1st Qu.: 99.451  
    ##  Mode  :character   Median :182.0   Median :  0.000   Median :100.000  
    ##                     Mean   :180.1   Mean   :  1.885   Mean   : 98.964  
    ##                     3rd Qu.:182.0   3rd Qu.:  1.000   3rd Qu.:100.000  
    ##                     Max.   :182.0   Max.   :178.000   Max.   :100.000

``` r
##### EDITABLE VARIABLE #####
lqual_threshold <- 2
#############################

# identify low qual loci
lqual_loci <- loci_completeness %>% 
  filter(missing_alleles > lqual_threshold) %>% 
  pull(locus)
# remove low qual loci from input cgMLST data
cgmlst_lc <- cgmlst %>% select(-all_of(lqual_loci))
# write to file
write.table(cgmlst_lc, here("cgmlst_lqual_loci_rm.tsv"),
            quote = F, row.names = F, sep = "\t")
# print filtering results
message(paste("Number of loci before filter:", ncol(cgmlst)-1))
```

    ## Number of loci before filter: 2952

``` r
message(paste("Number of loci after filter:", ncol(cgmlst_lc)-1))
```

    ## Number of loci after filter: 2728

``` r
message(paste("Number of loci removed:", ncol(cgmlst)-ncol(cgmlst_lc)))
```

    ## Number of loci removed: 224

``` r
message(paste0("Loci with ", lqual_threshold, " or less missing allele(s) were retained"))
```

    ## Loci with 2 or less missing allele(s) were retained

## Defining Core Genes

``` r
##### EDITABLE VARIABLE #####
core_threshold <- 1
#############################

# recompute the loci completeness
# of quality filtered scheme
filt_loci_completeness <- compute_lc(cgmlst_lc)
# determine core genome loci
core_loci <- filt_loci_completeness %>% 
  filter(missing_alleles <= core_threshold) %>% 
  pull(locus)

cgmlst_core <- cgmlst_lc %>% select(1, all_of(core_loci))
# write to file
write.table(cgmlst_core, here("cgmlst_core_loci.tsv"),
            quote = F, row.names = F, sep = "\t")
# print filtering results
message(paste("Number of loci before filter:", ncol(cgmlst_lc)-1))
```

    ## Number of loci before filter: 2728

``` r
message(paste("Number of loci after filter:", ncol(cgmlst_core)-1))
```

    ## Number of loci after filter: 2480

``` r
message(paste("Number of accessory loci found:", ncol(cgmlst_lc)-ncol(cgmlst_core)))
```

    ## Number of accessory loci found: 248

``` r
message(paste0("Core gene definition: less than or equal to ", core_threshold, " missing allele(s)"))
```

    ## Core gene definition: less than or equal to 1 missing allele(s)

## Genome Quality

``` r
# compute genome completeness
# given quality filtered scheme
genome_completeness <- compute_gc(cgmlst_core)
# write to file
write.table(genome_completeness, here("cgmlst_genome_qual.stats.tsv"),
            quote = F, row.names = F, sep = "\t")
# print data summary of genome completeness
summary(genome_completeness)
```

    ##       ID            valid_alleles  missing_alleles   completeness   
    ##  Length:182         Min.   :2437   Min.   : 0.000   Min.   : 98.27  
    ##  Class :character   1st Qu.:2480   1st Qu.: 0.000   1st Qu.:100.00  
    ##  Mode  :character   Median :2480   Median : 0.000   Median :100.00  
    ##                     Mean   :2478   Mean   : 2.209   Mean   : 99.91  
    ##                     3rd Qu.:2480   3rd Qu.: 0.000   3rd Qu.:100.00  
    ##                     Max.   :2480   Max.   :43.000   Max.   :100.00

``` r
##### EDITABLE VARIABLE #####
lqual_g_threshold <- 25
#############################

# identify low qual genomes
lqual_genomes <- genome_completeness %>% 
  filter(missing_alleles > lqual_g_threshold) %>% 
  pull(ID)
# remove low qual genomes from quality filtered cgmlst
cgmlst_final <- cgmlst_core %>% filter(!(`#Name` %in% lqual_genomes))
# remove low qual genomes from metadata
metadata <- meta %>% filter(!(ID %in% lqual_genomes))
# write to file
write.table(cgmlst_final, here("cgmlst_final.tsv"),
            quote = F, row.names = F, sep = "\t")
# print filtering results
message(paste("Number of genomes before filter:", nrow(cgmlst_core)))
```

    ## Number of genomes before filter: 182

``` r
message(paste("Number of genomes after filter:", nrow(cgmlst_final)))
```

    ## Number of genomes after filter: 175

``` r
message(paste("Number of genomes removed:", nrow(cgmlst_core)-nrow(cgmlst_final)))
```

    ## Number of genomes removed: 7

``` r
message(paste0("Genomes with ", lqual_g_threshold, " or less missing alleles were retained"))
```

    ## Genomes with 25 or less missing alleles were retained

# Hamming Distance

Distance-based and character-based methods can both be used to construct
dendrograms from cgMLST data. However, in the scope of this lab we will
only cover distance-based dendrograms, as character-based methods will
be covered extensively in other modules. In phylogenetic analysis,
distance-based approaches are rather flexible in the sense that they can
be constructed from any measure that quantifies genetic similarity,
including distances computed by alignment-free (e.g. Mash) or
alignment-based (e.g. BLAST) similarity search algorithms. Below, you
are introduced to a metric called the “Hamming distance” that is based
on computing a distance based on the number of differences between a
pair of character vectors.

Given two character vectors of equal lengths, hamming distance is the
total number of positions in which the two vectors are <u>different:</u>

Profile A: `[ 0 , 2 , 0 , 5 , 5 , 0 , 0 , 0 , 0 ]`

Profile B: `[ 0 , 1 , 0 , 4 , 3 , 0 , 0 , 0 , 0 ]`

  A != B: `[ 0 , 1 , 0 , 1 , 1 , 0 , 0 , 0 , 0 ]`

Hamming distance = sum( A != B ) = 3

``` r
dist_mat <- cgmlst_final %>% 
  column_to_rownames("#Name") %>% 
  t() %>% 
  hamming()
# print matrix dimension
# the dimension should be symmetric!
dim(dist_mat)
```

    ## [1] 175 175

In the context of two cgMLST profiles, a Hamming distance can be
calculated based on the number of differences in alleles at.all loci.
Hamming distances will be computed in an all vs all fashion to generate
a pairwise distance matrix that will serve as the input for
distance-based tree-building algorithms such as UPGMA and
Neighbour-joining. We will visualise the clustering patterns in the
distance matrix using the ComplexHeatmap package. We will also overlay
serovar information to examine inter- and intra-serovar distances.

``` r
# create column annotations for heatmap
# to display serovar information
heatmap_annot <- metadata$serovar
names(heatmap_annot) <- metadata$ID
heatmap_annot <- heatmap_annot[order(factor(names(heatmap_annot),
                                            levels = rownames(dist_mat)))]
# create heatmap
dist_mat %>% 
  Heatmap(
    name = "cgMLST\nDistance",
    show_row_names = F, # do not display row labels
    show_column_names = F, # do not display column labels
    # use custom color gradient
    col = colorRamp2(
      c(min(dist_mat), mean(dist_mat), max(dist_mat)),
      c("#7ece97", "#eebd32", "#f76c6a")
    ),
    # add column annotation to show serovar info
    top_annotation = HeatmapAnnotation(
      Serovar = heatmap_annot,
      col = list(
                    "Serovar" = structure(brewer.pal(length(unique(heatmap_annot)), "Set1"),
                                                                names = unique(heatmap_annot))
      )
    )
  )
```

![](Module_5_Lab_files/figure-markdown_github/distance%20matrix%20viz-1.png)

# Dendrogram Construction

Here you will construct a neighbour-joining tree using the `nj()`
function from the ape package. Alternatively, a UPGMA tree can be
constructed by simply replacing `method = 'nj'` with `method = 'upgma'`
in the code chunk below.

To visualise the resulting dendrogram, you will interact with the R
package ggtree, which offers an extensive suite of functions to
manipulate, visualize, and annotate tree-like data structures. In this
section, you will be introduced to the different visual capabilities of
the ggtree package, and progressively update the same tree with several
layers of visual annotations based on available metadata.

## A Simple Tree Vis

To start, run the following code chunk to plot a circular tree of the
entire dataset with the tree tips colored by serovar information.

> You can assign a different metadata field to the `color_var` variable
> to update the mapping of the color aesthetics in the tree. For example
> setting `color_var = "Country"` will color the tree tips by the
> country of origin

``` r
##### EDITABLE VARIABLE #####
color_var <- "serovar"
#############################

# set random seed
set.seed(123)
# determine category count
# in the color aes variable
n_colors <- length(unique(pull(metadata, !!sym(color_var))))
# construct a core genome tree 
# using nj algorithm
cg_tree <- distance_tree(
  matrix = dist_mat,
  method = "nj"
)
# plot core genome tree and
# colouring the tree tips 
# by color_var
cg_tree_p <- cg_tree %>% 
  ggtree(layout = "circular",
         size = 0.75) %<+% metadata +
  geom_tippoint(aes(color = !!sym(color_var)),
                size = 2) +
  guides(color = guide_legend(override.aes = list(size = 3) ) ) +
  scale_color_manual(values = distinctColorPalette(n_colors))
# print tree plot object
cg_tree_p
```

![](Module_5_Lab_files/figure-markdown_github/core%20genome%20tree-1.png)

## Clustering by Distance

Identifying clusters in genomic data through the application of a
distance threshold so that groups of genomes sharing a below-threshold
distance level (i.e. highly similar profiles) is a common practice in
genomic surveillance and epidemiological investigations. Detecting novel
clusters comprising pathogen isolates from human clinical cases can
signal the emergence of an outbreak requiring a public health response
and can provide important epidemiological insights on outbreak
progression.

Similarly, the co-clustering of outbreak isolates with isolates from
food/environmental sources can help link the outbreak to possible
sources/reservoirs of the pathogen in order to inform prevention and
control measures. In this section, you will generate genomic clusters
from the dataset by applying several distance cutoffs. You will then
place clusters within the dendrogram and analyse cluster memberships to
spot possible outbreaks in the dataset.

``` r
# define clustering distance cutoffs
dist_cutoff <- c(0, seq(5, 100, 5), seq(200, 1000, 100))
# perform complete linkage clustering
hclust_res <- map(dist_cutoff, function(x) {
  dist_mat %>% 
    as.dist() %>% 
    hclust(method = "complete") %>% 
    cutree(h = x) %>% 
    as.factor()
})
names(hclust_res) <- paste0("clust_", dist_cutoff)
# print clustering results table
(
  clusters <- data.frame(hclust_res) %>% 
    rownames_to_column("ID")
  )
```

    ##                     ID clust_0 clust_5 clust_10 clust_15 clust_20 clust_25
    ## 1              FCC0146       1       1        1        1        1        1
    ## 2              FDN0191       2       2        2        2        2        2
    ## 3              FCC0228       3       3        3        3        3        3
    ## 4       MDH_2014_00252       4       4        4        4        4        4
    ## 5         FDA361154004       5       5        5        5        5        5
    ## 6       FDA769578_1_14       6       6        6        6        6        6
    ## 7     FDA684331_C1_6_3       7       7        7        7        7        7
    ## 8       MDH_2013_00199       8       8        8        8        8        8
    ## 9          FDA478056_1       9       9        9        9        9        9
    ## 10   FDA513934_2124_B2      10      10       10       10       10       10
    ## 11      ARIM_SE1187_06      11      11       11       11       11       11
    ## 12             FCC0232       3       3        3        3        3        3
    ## 13       FDA768497_1_1       6       6        6        6        6        6
    ## 14       FDA417303_212      12      12       12       12       12       12
    ## 15       FDA417303_211      13      12       12       12       12       12
    ## 16       FDA417303_213      14      12       12       12       12       12
    ## 17             FDN0186      10      10       10       10       10       10
    ## 18             FDN0187      10      10       10       10       10       10
    ## 19             FDN0188      10      10       10       10       10       10
    ## 20    FDA684331_C1_4_2       7       7        7        7        7        7
    ## 21           FDA532130      15      13       13       13        1        1
    ## 22           FDA488275      16       1        1        1        1        1
    ## 23         CFSAN032488      17      14       14       14       11       11
    ## 24         CFSAN032481      18      11       11       11       11       11
    ## 25         CFSAN032485      19      15       15       15       13       11
    ## 26  CDPHFDLB_F14M00906      20      16       16       16       14       13
    ## 27        FDA315382737      15      13       13       13        1        1
    ## 28        FDA315101734      21      17       17       13        1        1
    ## 29        FDA515101576      15      13       13       13        1        1
    ## 30        FDA316235162      22      18        5        5        5        5
    ## 31        FDA314996875      23      13       13       13        1        1
    ## 32        FDA315900197      24      13       13       13        1        1
    ## 33             FDA3959      15      13       13       13        1        1
    ## 34        FDA316118221      15      13       13       13        1        1
    ## 35        FDA316235718      15      13       13       13        1        1
    ## 36        FDA316046633      15      13       13       13        1        1
    ## 37  CDPHFDLB_F14M00970      25      16       16       16       14       13
    ## 38  CDPHFDLB_F14M00969      26      16       16       16       14       13
    ## 39  CDPHFDLB_F14M00967      26      16       16       16       14       13
    ## 40   FDA513934_2124_E1      27      10       10       10       10       10
    ## 41   FDA513934_2124_B1      10      10       10       10       10       10
    ## 42    FDA513934_2124_D      10      10       10       10       10       10
    ## 43   FDA513934_2124_E2      28      19       18       17       15       14
    ## 44    FDA513934_2124_C      10      10       10       10       10       10
    ## 45       FDA516834_3_5      10      10       10       10       10       10
    ## 46       FDA516834_3_3      10      10       10       10       10       10
    ## 47    FDA513934_2124_A      29      10       10       10       10       10
    ## 48    FDA513934_2124_F      10      10       10       10       10       10
    ## 49      FDA757378_1_32      30      20       19       18       16       15
    ## 50      FDA757378_1_13      31      20       19       18       16       15
    ## 51         FDA515920_2      32       1        1        1        1        1
    ## 52         FDA525769_1      33      21       20       19       17       16
    ## 53       ARIM_SE135_06      34      22       15       15       13       11
    ## 54         FDA468879_3      35       1        1        1        1        1
    ## 55         FDA468879_5       1       1        1        1        1        1
    ## 56         FDA525769_2      36      21       20       19       17       16
    ## 57         FDA495297_1      37       1        1        1        1        1
    ## 58         FDA468879_4      38       1        1        1        1        1
    ## 59          2012K_0283      39      23       21       20       18       17
    ## 60                1818      40      24       22       21       19       18
    ## 61                1823      41      25       23       22       20       18
    ## 62               H9556      42      26       24       23       21       19
    ## 63          2010K_0675      43      27       25       24       22       20
    ## 64                1847      44      28       26       22       20       18
    ## 65    FDA546180_78_2_1      45      29       27       25       23       21
    ## 66          2010K_0362      46      30       28       26       24       22
    ## 67               K3310      47      31       29       27       25       23
    ## 68          2010K_1946      48      32       30       28       26       24
    ## 69                1819      41      25       23       22       20       18
    ## 70          2010K_0668      43      27       25       24       22       20
    ## 71          2009K_1742      49      33       31       29       27       25
    ## 72          2010K_0672      43      27       25       24       22       20
    ## 73          2011K_0079      50      34       32       30       28       26
    ## 74    FDA546180_79_3_4      51      29       27       25       23       21
    ## 75    FDA546180_78_5_2      45      29       27       25       23       21
    ## 76          2010K_0358      52      35       28       26       24       22
    ## 77             FNE0103      53       8        8        8        8        8
    ## 78          2011K_0019      54      36       33       30       28       26
    ## 79         NY_swgs1123      55      37       34       31       29       27
    ## 80                1822      41      25       23       22       20       18
    ## 81               H9558      42      26       24       23       21       19
    ## 82         NY_swgs1111      56      38       35       32       30       28
    ## 83          2010K_0666      43      27       25       24       22       20
    ## 84         CFSAN032482      18      11       11       11       11       11
    ## 85          2010K_0673      43      27       25       24       22       20
    ## 86          2011K_1668      57      39       36       33       31       29
    ## 87    FDA546180_79_2_2      58      29       27       25       23       21
    ## 88          2010K_0667      43      27       25       24       22       20
    ## 89          2010K_2617      59      40       33       30       28       26
    ## 90          2010K_0669      60      27       25       24       22       20
    ## 91          2010K_0338      61      35       28       26       24       22
    ## 92                1846      62      28       26       22       20       18
    ## 93             FNE0140       8       8        8        8        8        8
    ## 94          2012K_0285      39      23       21       20       18       17
    ## 95          2011K_1667      57      39       36       33       31       29
    ## 96          2011K_0104      63      36       33       30       28       26
    ## 97               K2330      64      41       37       34       25       23
    ## 98         FDA478056_2      65       9        9        9        9        9
    ## 99          2010K_0351      66      35       28       26       24       22
    ## 100               1820      41      25       23       22       20       18
    ## 101         2012K_0284      39      23       21       20       18       17
    ## 102         2012K_0499      67      42       38       35       32       30
    ## 103         2011K_1845      68      43       39       36       33       31
    ## 104         2011K_1846      69      43       39       36       33       31
    ## 105         2010K_1947      48      32       30       28       26       24
    ## 106     MDH_2014_00782      70      44       40       37       34       32
    ## 107     MDH_2014_00234       4       4        4        4        4        4
    ## 108     MDH_2014_00211      71      45       41       38       35       33
    ## 109   FDA451897_C1_2_2      72       2        2        2        2        2
    ## 110  FDA451896_13a_1_1      72       2        2        2        2        2
    ## 111               1827      41      25       23       22       20       18
    ## 112         2012K_0627      73      46       42       39       36       34
    ## 113               1825      74      47       43       40       37       35
    ## 114    FDA535296_1_2_2      15      13       13       13        1        1
    ## 115     MDH_2013_00060      75      10       10       10       10       10
    ## 116        FDA482179_1      76      13       13       13        1        1
    ## 117     MDH_2014_00255      77      48       44       41       26       24
    ## 118       FDA490163_67      15      13       13       13        1        1
    ## 119     MDH_2014_00210      78      45       41       38       35       33
    ## 120     MDH_2014_00253      79       4        4        4        4        4
    ## 121     MDH_2014_00249      80      49       45       28       26       24
    ## 122     MDH_2014_00212      71      45       41       38       35       33
    ## 123         2012K_0644      81      46       42       39       36       34
    ## 124         2012K_0501      82      42       38       35       32       30
    ## 125              K3308      83      50       29       27       25       23
    ## 126         2010K_0678      84      27       25       24       22       20
    ## 127         2009K_1740      49      33       31       29       27       25
    ## 128     MDH_2014_00239      85      51       46       28       26       24
    ## 129     MDH_2014_00238      86      51       46       28       26       24
    ## 130     MDH_2014_00227      87      27       25       24       22       20
    ## 131     MDH_2014_00230      88      27       25       24       22       20
    ## 132     MDH_2014_00219      89      52       47       42       38       33
    ## 133     MDH_2014_00254       4       4        4        4        4        4
    ## 134     MDH_2014_00228      89      52       47       42       38       33
    ## 135     MDH_2014_00240      90      51       46       28       26       24
    ## 136     MDH_2014_00242      91      51       46       28       26       24
    ## 137          FDA126722      92      53       39       36       33       31
    ## 138     MDH_2014_00223      89      52       47       42       38       33
    ## 139        FDA119341_3      93      53       39       36       33       31
    ## 140        FDA482178_2      15      13       13       13        1        1
    ## 141  FDA451896_13b_1_1      72       2        2        2        2        2
    ## 142        FDA489158_9      94      13       13       13        1        1
    ## 143               1826      41      25       23       22       20       18
    ## 144        CFSAN032487      95      14       14       14       11       11
    ## 145               1831      96      54       48       43       20       18
    ## 146              K2331      64      41       37       34       25       23
    ## 147     MDH_2014_00225      89      52       47       42       38       33
    ## 148         2010K_0677      43      27       25       24       22       20
    ## 149         2012K_0628      81      46       42       39       36       34
    ## 150   FDA451897_C2_1_1      97       2        2        2        2        2
    ## 151            FCC0132      38       1        1        1        1        1
    ## 152     MDH_2014_00786      98      55       49       44       39       36
    ## 153     MDH_2014_00785      99      44       40       37       34       32
    ## 154     MDH_2014_00218      89      52       47       42       38       33
    ## 155     MDH_2014_00251      87      27       25       24       22       20
    ## 156     MDH_2014_00222      89      52       47       42       38       33
    ## 157     MDH_2014_00229     100      56       50       45       22       20
    ## 158     MDH_2014_00209      71      45       41       38       35       33
    ## 159     MDH_2014_00244      91      51       46       28       26       24
    ## 160     MDH_2013_00036     101      57       51       46       40       28
    ## 161    FDA535296_2_4_2     102      13       13       13        1        1
    ## 162     MDH_2014_00250      80      49       45       28       26       24
    ## 163     MDH_2014_00779      99      44       40       37       34       32
    ## 164         2010K_0348      61      35       28       26       24       22
    ## 165    FDA768495_26_25     103       6        6        6        6        6
    ## 166    FDA768495_24_19     104      58        6        6        6        6
    ## 167     FDA768495_10_1     105      58        6        6        6        6
    ## 168    FDA768495_20_13     106      59        6        6        6        6
    ## 169               1830      96      54       48       43       20       18
    ## 170               1843      44      28       26       22       20       18
    ## 171               1813     107      60       22       21       19       18
    ## 172               1834      96      54       48       43       20       18
    ## 173               1824     108      25       23       22       20       18
    ## 174               1844      44      28       26       22       20       18
    ## 175               1842      44      28       26       22       20       18
    ##     clust_30 clust_35 clust_40 clust_45 clust_50 clust_55 clust_60 clust_65
    ## 1          1        1        1        1        1        1        1        1
    ## 2          2        2        2        2        2        2        2        2
    ## 3          3        3        3        3        3        3        3        3
    ## 4          4        4        4        4        4        4        4        4
    ## 5          5        5        5        5        5        5        5        5
    ## 6          6        6        6        6        6        6        6        6
    ## 7          7        7        7        7        7        7        7        7
    ## 8          8        8        8        8        8        8        8        8
    ## 9          9        9        9        9        9        9        9        9
    ## 10        10       10       10       10       10       10       10       10
    ## 11        11       11       11       11       11       11       11       11
    ## 12         3        3        3        3        3        3        3        3
    ## 13         6        6        6        6        6        6        6        6
    ## 14        12       12       12       12       12       12       12       12
    ## 15        12       12       12       12       12       12       12       12
    ## 16        12       12       12       12       12       12       12       12
    ## 17        10       10       10       10       10       10       10       10
    ## 18        10       10       10       10       10       10       10       10
    ## 19        10       10       10       10       10       10       10       10
    ## 20         7        7        7        7        7        7        7        7
    ## 21         1        1        1        1        1        1        1        1
    ## 22         1        1        1        1        1        1        1        1
    ## 23        11       11       11       11       11       11       11       11
    ## 24        11       11       11       11       11       11       11       11
    ## 25        11       11       11       11       11       11       11       11
    ## 26        13       13       13       13       13       13       13       13
    ## 27         1        1        1        1        1        1        1        1
    ## 28         1        1        1        1        1        1        1        1
    ## 29         1        1        1        1        1        1        1        1
    ## 30         5        5        5        5        5        5        5        5
    ## 31         1        1        1        1        1        1        1        1
    ## 32         1        1        1        1        1        1        1        1
    ## 33         1        1        1        1        1        1        1        1
    ## 34         1        1        1        1        1        1        1        1
    ## 35         1        1        1        1        1        1        1        1
    ## 36         1        1        1        1        1        1        1        1
    ## 37        13       13       13       13       13       13       13       13
    ## 38        13       13       13       13       13       13       13       13
    ## 39        13       13       13       13       13       13       13       13
    ## 40        10       10       10       10       10       10       10       10
    ## 41        10       10       10       10       10       10       10       10
    ## 42        10       10       10       10       10       10       10       10
    ## 43        10       10       10       10       10       10       10       10
    ## 44        10       10       10       10       10       10       10       10
    ## 45        10       10       10       10       10       10       10       10
    ## 46        10       10       10       10       10       10       10       10
    ## 47        10       10       10       10       10       10       10       10
    ## 48        10       10       10       10       10       10       10       10
    ## 49        14       14       14       14       14       14       14       14
    ## 50        14       14       14       14       14       14       14       14
    ## 51         1        1        1        1        1        1        1        1
    ## 52        15       15       11       11       11       11       11       11
    ## 53        11       11       11       11       11       11       11       11
    ## 54         1        1        1        1        1        1        1        1
    ## 55         1        1        1        1        1        1        1        1
    ## 56        15       15       11       11       11       11       11       11
    ## 57         1        1        1        1        1        1        1        1
    ## 58         1        1        1        1        1        1        1        1
    ## 59        16       16       15       15       15       15       15       15
    ## 60        17       17       16       16       16       16       16       16
    ## 61        17       17       16       16       16       16       16       16
    ## 62        18       18       17       17       17       17       17       17
    ## 63        19       19       18       18       18       18       18       18
    ## 64        17       17       16       16       16       16       16       16
    ## 65        20        8        8        8        8        8        8        8
    ## 66        21       20       19       19       19       19       19       19
    ## 67        16       16       15       15       15       15       15       15
    ## 68        22       21       20       20       18       18       18       18
    ## 69        17       17       16       16       16       16       16       16
    ## 70        19       19       18       18       18       18       18       18
    ## 71        23       22       21       21       20       20       20       20
    ## 72        19       19       18       18       18       18       18       18
    ## 73        24       23       22       22       21       21       21       21
    ## 74        20        8        8        8        8        8        8        8
    ## 75        20        8        8        8        8        8        8        8
    ## 76        21       20       19       19       19       19       19       19
    ## 77         8        8        8        8        8        8        8        8
    ## 78        24       23       22       22       21       21       21       21
    ## 79        25       24       23       23       22       22       22       22
    ## 80        17       17       16       16       16       16       16       16
    ## 81        18       18       17       17       17       17       17       17
    ## 82        26       25       23       23       22       22       22       22
    ## 83        19       19       18       18       18       18       18       18
    ## 84        11       11       11       11       11       11       11       11
    ## 85        19       19       18       18       18       18       18       18
    ## 86        27       26       24       24       23       23       23       23
    ## 87        20        8        8        8        8        8        8        8
    ## 88        19       19       18       18       18       18       18       18
    ## 89        24       23       22       22       21       21       21       21
    ## 90        19       19       18       18       18       18       18       18
    ## 91        21       20       19       19       19       19       19       19
    ## 92        17       17       16       16       16       16       16       16
    ## 93         8        8        8        8        8        8        8        8
    ## 94        16       16       15       15       15       15       15       15
    ## 95        27       26       24       24       23       23       23       23
    ## 96        24       23       22       22       21       21       21       21
    ## 97        16       16       15       15       15       15       15       15
    ## 98         9        9        9        9        9        9        9        9
    ## 99        21       20       19       19       19       19       19       19
    ## 100       17       17       16       16       16       16       16       16
    ## 101       16       16       15       15       15       15       15       15
    ## 102       28       27       25       25       24       18       18       18
    ## 103       29       28       26       26       25       24       24       24
    ## 104       29       28       26       26       25       24       24       24
    ## 105       22       21       20       20       18       18       18       18
    ## 106       30       29       27       27       11       11       11       11
    ## 107        4        4        4        4        4        4        4        4
    ## 108       31       30       28       28       26       25       25       25
    ## 109        2        2        2        2        2        2        2        2
    ## 110        2        2        2        2        2        2        2        2
    ## 111       17       17       16       16       16       16       16       16
    ## 112       32       31       29       29       27       26       26       26
    ## 113       33       32       30       16       16       16       16       16
    ## 114        1        1        1        1        1        1        1        1
    ## 115       10       10       10       10       10       10       10       10
    ## 116        1        1        1        1        1        1        1        1
    ## 117       22       21       20       20       18       18       18       18
    ## 118        1        1        1        1        1        1        1        1
    ## 119       31       30       28       28       26       25       25       25
    ## 120        4        4        4        4        4        4        4        4
    ## 121       22       21       20       20       18       18       18       18
    ## 122       31       30       28       28       26       25       25       25
    ## 123       32       31       29       29       27       26       26       26
    ## 124       28       27       25       25       24       18       18       18
    ## 125       16       16       15       15       15       15       15       15
    ## 126       19       19       18       18       18       18       18       18
    ## 127       23       22       21       21       20       20       20       20
    ## 128       22       21       20       20       18       18       18       18
    ## 129       22       21       20       20       18       18       18       18
    ## 130       19       19       18       18       18       18       18       18
    ## 131       19       19       18       18       18       18       18       18
    ## 132       31       30       28       28       26       25       25       25
    ## 133        4        4        4        4        4        4        4        4
    ## 134       31       30       28       28       26       25       25       25
    ## 135       22       21       20       20       18       18       18       18
    ## 136       22       21       20       20       18       18       18       18
    ## 137       29       28       26       26       25       24       24       24
    ## 138       31       30       28       28       26       25       25       25
    ## 139       29       28       26       26       25       24       24       24
    ## 140        1        1        1        1        1        1        1        1
    ## 141        2        2        2        2        2        2        2        2
    ## 142        1        1        1        1        1        1        1        1
    ## 143       17       17       16       16       16       16       16       16
    ## 144       11       11       11       11       11       11       11       11
    ## 145       17       17       16       16       16       16       16       16
    ## 146       16       16       15       15       15       15       15       15
    ## 147       31       30       28       28       26       25       25       25
    ## 148       19       19       18       18       18       18       18       18
    ## 149       32       31       29       29       27       26       26       26
    ## 150        2        2        2        2        2        2        2        2
    ## 151        1        1        1        1        1        1        1        1
    ## 152       34       33       31       30       28       11       11       11
    ## 153       30       29       27       27       11       11       11       11
    ## 154       31       30       28       28       26       25       25       25
    ## 155       19       19       18       18       18       18       18       18
    ## 156       31       30       28       28       26       25       25       25
    ## 157       19       19       18       18       18       18       18       18
    ## 158       31       30       28       28       26       25       25       25
    ## 159       22       21       20       20       18       18       18       18
    ## 160       26       25       23       23       22       22       22       22
    ## 161        1        1        1        1        1        1        1        1
    ## 162       22       21       20       20       18       18       18       18
    ## 163       30       29       27       27       11       11       11       11
    ## 164       21       20       19       19       19       19       19       19
    ## 165        6        6        6        6        6        6        6        6
    ## 166        6        6        6        6        6        6        6        6
    ## 167        6        6        6        6        6        6        6        6
    ## 168        6        6        6        6        6        6        6        6
    ## 169       17       17       16       16       16       16       16       16
    ## 170       17       17       16       16       16       16       16       16
    ## 171       17       17       16       16       16       16       16       16
    ## 172       17       17       16       16       16       16       16       16
    ## 173       17       17       16       16       16       16       16       16
    ## 174       17       17       16       16       16       16       16       16
    ## 175       17       17       16       16       16       16       16       16
    ##     clust_70 clust_75 clust_80 clust_85 clust_90 clust_95 clust_100 clust_200
    ## 1          1        1        1        1        1        1         1         1
    ## 2          2        2        2        2        2        2         2         2
    ## 3          3        3        3        3        3        3         3         3
    ## 4          4        4        4        4        4        4         4         4
    ## 5          5        5        5        5        5        5         5         5
    ## 6          6        6        6        6        6        6         6         6
    ## 7          7        7        7        7        7        7         7         7
    ## 8          8        8        8        8        8        8         8         8
    ## 9          9        9        9        9        9        9         9         9
    ## 10        10       10       10       10       10       10        10        10
    ## 11        11       11       11       11       11       11        11        11
    ## 12         3        3        3        3        3        3         3         3
    ## 13         6        6        6        6        6        6         6         6
    ## 14        12       12       12       12       12       12        12        10
    ## 15        12       12       12       12       12       12        12        10
    ## 16        12       12       12       12       12       12        12        10
    ## 17        10       10       10       10       10       10        10        10
    ## 18        10       10       10       10       10       10        10        10
    ## 19        10       10       10       10       10       10        10        10
    ## 20         7        7        7        7        7        7         7         7
    ## 21         1        1        1        1        1        1         1         1
    ## 22         1        1        1        1        1        1         1         1
    ## 23        11       11       11       11       11       11        11        11
    ## 24        11       11       11       11       11       11        11        11
    ## 25        11       11       11       11       11       11        11        11
    ## 26        13       13       13       13       13       13        13        12
    ## 27         1        1        1        1        1        1         1         1
    ## 28         1        1        1        1        1        1         1         1
    ## 29         1        1        1        1        1        1         1         1
    ## 30         5        5        5        5        5        5         5         5
    ## 31         1        1        1        1        1        1         1         1
    ## 32         1        1        1        1        1        1         1         1
    ## 33         1        1        1        1        1        1         1         1
    ## 34         1        1        1        1        1        1         1         1
    ## 35         1        1        1        1        1        1         1         1
    ## 36         1        1        1        1        1        1         1         1
    ## 37        13       13       13       13       13       13        13        12
    ## 38        13       13       13       13       13       13        13        12
    ## 39        13       13       13       13       13       13        13        12
    ## 40        10       10       10       10       10       10        10        10
    ## 41        10       10       10       10       10       10        10        10
    ## 42        10       10       10       10       10       10        10        10
    ## 43        10       10       10       10       10       10        10        10
    ## 44        10       10       10       10       10       10        10        10
    ## 45        10       10       10       10       10       10        10        10
    ## 46        10       10       10       10       10       10        10        10
    ## 47        10       10       10       10       10       10        10        10
    ## 48        10       10       10       10       10       10        10        10
    ## 49        14       14       14       14       14       14        14        13
    ## 50        14       14       14       14       14       14        14        13
    ## 51         1        1        1        1        1        1         1         1
    ## 52        11       11       11       11       11       11        11        11
    ## 53        11       11       11       11       11       11        11        11
    ## 54         1        1        1        1        1        1         1         1
    ## 55         1        1        1        1        1        1         1         1
    ## 56        11       11       11       11       11       11        11        11
    ## 57         1        1        1        1        1        1         1         1
    ## 58         1        1        1        1        1        1         1         1
    ## 59        15       15       15       15       15        4         4         4
    ## 60        16       16       16       16       16       15        15        14
    ## 61        16       16       16       16       16       15        15        14
    ## 62        17       17       17       17        7        7         7         7
    ## 63        18       18       18       18       17       16        16         4
    ## 64        16       16       16       16       16       15        15        14
    ## 65         8        8        8        8        8        8         8         8
    ## 66        19       19       19       19       18       17        17         4
    ## 67        15       15       15       15       15        4         4         4
    ## 68        18       18       18       18       17       16        16         4
    ## 69        16       16       16       16       16       15        15        14
    ## 70        18       18       18       18       17       16        16         4
    ## 71        20       20       20       20       19       18        18         4
    ## 72        18       18       18       18       17       16        16         4
    ## 73        21       21       21       21       20       19         4         4
    ## 74         8        8        8        8        8        8         8         8
    ## 75         8        8        8        8        8        8         8         8
    ## 76        19       19       19       19       18       17        17         4
    ## 77         8        8        8        8        8        8         8         8
    ## 78        21       21       21       21       20       19         4         4
    ## 79        22       22       22       22       21       20        19        15
    ## 80        16       16       16       16       16       15        15        14
    ## 81        17       17       17       17        7        7         7         7
    ## 82        22       22       22       22       21       20        19        15
    ## 83        18       18       18       18       17       16        16         4
    ## 84        11       11       11       11       11       11        11        11
    ## 85        18       18       18       18       17       16        16         4
    ## 86        19       19       19       19       18       17        17         4
    ## 87         8        8        8        8        8        8         8         8
    ## 88        18       18       18       18       17       16        16         4
    ## 89        21       21       21       21       20       19         4         4
    ## 90        18       18       18       18       17       16        16         4
    ## 91        19       19       19       19       18       17        17         4
    ## 92        16       16       16       16       16       15        15        14
    ## 93         8        8        8        8        8        8         8         8
    ## 94        15       15       15       15       15        4         4         4
    ## 95        19       19       19       19       18       17        17         4
    ## 96        21       21       21       21       20       19         4         4
    ## 97        15       15       15       15       15        4         4         4
    ## 98         9        9        9        9        9        9         9         9
    ## 99        19       19       19       19       18       17        17         4
    ## 100       16       16       16       16       16       15        15        14
    ## 101       15       15       15       15       15        4         4         4
    ## 102       18       18       18       18       17       16        16         4
    ## 103       23       23       23       23       22       21        20        16
    ## 104       23       23       23       23       22       21        20        16
    ## 105       18       18       18       18       17       16        16         4
    ## 106       11       11       11       11       11       11        11        11
    ## 107        4        4        4        4        4        4         4         4
    ## 108       24       24        4        4        4        4         4         4
    ## 109        2        2        2        2        2        2         2         2
    ## 110        2        2        2        2        2        2         2         2
    ## 111       16       16       16       16       16       15        15        14
    ## 112       25        7        7        7        7        7         7         7
    ## 113       16       16       16       16       16       15        15        14
    ## 114        1        1        1        1        1        1         1         1
    ## 115       10       10       10       10       10       10        10        10
    ## 116        1        1        1        1        1        1         1         1
    ## 117       18       18       18       18       17       16        16         4
    ## 118        1        1        1        1        1        1         1         1
    ## 119       24       24        4        4        4        4         4         4
    ## 120        4        4        4        4        4        4         4         4
    ## 121       18       18       18       18       17       16        16         4
    ## 122       24       24        4        4        4        4         4         4
    ## 123       25        7        7        7        7        7         7         7
    ## 124       18       18       18       18       17       16        16         4
    ## 125       15       15       15       15       15        4         4         4
    ## 126       18       18       18       18       17       16        16         4
    ## 127       20       20       20       20       19       18        18         4
    ## 128       18       18       18       18       17       16        16         4
    ## 129       18       18       18       18       17       16        16         4
    ## 130       18       18       18       18       17       16        16         4
    ## 131       18       18       18       18       17       16        16         4
    ## 132       24       24        4        4        4        4         4         4
    ## 133        4        4        4        4        4        4         4         4
    ## 134       24       24        4        4        4        4         4         4
    ## 135       18       18       18       18       17       16        16         4
    ## 136       18       18       18       18       17       16        16         4
    ## 137       23       23       23       23       22       21        20        16
    ## 138       24       24        4        4        4        4         4         4
    ## 139       23       23       23       23       22       21        20        16
    ## 140        1        1        1        1        1        1         1         1
    ## 141        2        2        2        2        2        2         2         2
    ## 142        1        1        1        1        1        1         1         1
    ## 143       16       16       16       16       16       15        15        14
    ## 144       11       11       11       11       11       11        11        11
    ## 145       16       16       16       16       16       15        15        14
    ## 146       15       15       15       15       15        4         4         4
    ## 147       24       24        4        4        4        4         4         4
    ## 148       18       18       18       18       17       16        16         4
    ## 149       25        7        7        7        7        7         7         7
    ## 150        2        2        2        2        2        2         2         2
    ## 151        1        1        1        1        1        1         1         1
    ## 152       11       11       11       11       11       11        11        11
    ## 153       11       11       11       11       11       11        11        11
    ## 154       24       24        4        4        4        4         4         4
    ## 155       18       18       18       18       17       16        16         4
    ## 156       24       24        4        4        4        4         4         4
    ## 157       18       18       18       18       17       16        16         4
    ## 158       24       24        4        4        4        4         4         4
    ## 159       18       18       18       18       17       16        16         4
    ## 160       22       22       22       22       21       20        19        15
    ## 161        1        1        1        1        1        1         1         1
    ## 162       18       18       18       18       17       16        16         4
    ## 163       11       11       11       11       11       11        11        11
    ## 164       19       19       19       19       18       17        17         4
    ## 165        6        6        6        6        6        6         6         6
    ## 166        6        6        6        6        6        6         6         6
    ## 167        6        6        6        6        6        6         6         6
    ## 168        6        6        6        6        6        6         6         6
    ## 169       16       16       16       16       16       15        15        14
    ## 170       16       16       16       16       16       15        15        14
    ## 171       16       16       16       16       16       15        15        14
    ## 172       16       16       16       16       16       15        15        14
    ## 173       16       16       16       16       16       15        15        14
    ## 174       16       16       16       16       16       15        15        14
    ## 175       16       16       16       16       16       15        15        14
    ##     clust_300 clust_400 clust_500 clust_600 clust_700 clust_800 clust_900
    ## 1           1         1         1         1         1         1         1
    ## 2           2         2         2         2         2         2         2
    ## 3           3         3         3         3         3         3         3
    ## 4           4         4         4         4         4         4         4
    ## 5           5         5         5         5         5         5         5
    ## 6           6         6         6         6         6         6         6
    ## 7           4         4         4         4         4         4         4
    ## 8           7         7         7         7         7         7         7
    ## 9           8         8         8         8         8         8         8
    ## 10          9         9         9         9         9         9         9
    ## 11          4         4         4         4         4         4         4
    ## 12          3         3         3         3         3         3         3
    ## 13          6         6         6         6         6         6         6
    ## 14          9         9         9         9         9         9         9
    ## 15          9         9         9         9         9         9         9
    ## 16          9         9         9         9         9         9         9
    ## 17          9         9         9         9         9         9         9
    ## 18          9         9         9         9         9         9         9
    ## 19          9         9         9         9         9         9         9
    ## 20          4         4         4         4         4         4         4
    ## 21          1         1         1         1         1         1         1
    ## 22          1         1         1         1         1         1         1
    ## 23          4         4         4         4         4         4         4
    ## 24          4         4         4         4         4         4         4
    ## 25          4         4         4         4         4         4         4
    ## 26         10         6         6         6         6         6         6
    ## 27          1         1         1         1         1         1         1
    ## 28          1         1         1         1         1         1         1
    ## 29          1         1         1         1         1         1         1
    ## 30          5         5         5         5         5         5         5
    ## 31          1         1         1         1         1         1         1
    ## 32          1         1         1         1         1         1         1
    ## 33          1         1         1         1         1         1         1
    ## 34          1         1         1         1         1         1         1
    ## 35          1         1         1         1         1         1         1
    ## 36          1         1         1         1         1         1         1
    ## 37         10         6         6         6         6         6         6
    ## 38         10         6         6         6         6         6         6
    ## 39         10         6         6         6         6         6         6
    ## 40          9         9         9         9         9         9         9
    ## 41          9         9         9         9         9         9         9
    ## 42          9         9         9         9         9         9         9
    ## 43          9         9         9         9         9         9         9
    ## 44          9         9         9         9         9         9         9
    ## 45          9         9         9         9         9         9         9
    ## 46          9         9         9         9         9         9         9
    ## 47          9         9         9         9         9         9         9
    ## 48          9         9         9         9         9         9         9
    ## 49         11        10        10        10        10        10        10
    ## 50         11        10        10        10        10        10        10
    ## 51          1         1         1         1         1         1         1
    ## 52          4         4         4         4         4         4         4
    ## 53          4         4         4         4         4         4         4
    ## 54          1         1         1         1         1         1         1
    ## 55          1         1         1         1         1         1         1
    ## 56          4         4         4         4         4         4         4
    ## 57          1         1         1         1         1         1         1
    ## 58          1         1         1         1         1         1         1
    ## 59          4         4         4         4         4         4         4
    ## 60          9         9         9         9         9         9         9
    ## 61          9         9         9         9         9         9         9
    ## 62          4         4         4         4         4         4         4
    ## 63          4         4         4         4         4         4         4
    ## 64          9         9         9         9         9         9         9
    ## 65          7         7         7         7         7         7         7
    ## 66          4         4         4         4         4         4         4
    ## 67          4         4         4         4         4         4         4
    ## 68          4         4         4         4         4         4         4
    ## 69          9         9         9         9         9         9         9
    ## 70          4         4         4         4         4         4         4
    ## 71          4         4         4         4         4         4         4
    ## 72          4         4         4         4         4         4         4
    ## 73          4         4         4         4         4         4         4
    ## 74          7         7         7         7         7         7         7
    ## 75          7         7         7         7         7         7         7
    ## 76          4         4         4         4         4         4         4
    ## 77          7         7         7         7         7         7         7
    ## 78          4         4         4         4         4         4         4
    ## 79         12         9         9         9         9         9         9
    ## 80          9         9         9         9         9         9         9
    ## 81          4         4         4         4         4         4         4
    ## 82         12         9         9         9         9         9         9
    ## 83          4         4         4         4         4         4         4
    ## 84          4         4         4         4         4         4         4
    ## 85          4         4         4         4         4         4         4
    ## 86          4         4         4         4         4         4         4
    ## 87          7         7         7         7         7         7         7
    ## 88          4         4         4         4         4         4         4
    ## 89          4         4         4         4         4         4         4
    ## 90          4         4         4         4         4         4         4
    ## 91          4         4         4         4         4         4         4
    ## 92          9         9         9         9         9         9         9
    ## 93          7         7         7         7         7         7         7
    ## 94          4         4         4         4         4         4         4
    ## 95          4         4         4         4         4         4         4
    ## 96          4         4         4         4         4         4         4
    ## 97          4         4         4         4         4         4         4
    ## 98          8         8         8         8         8         8         8
    ## 99          4         4         4         4         4         4         4
    ## 100         9         9         9         9         9         9         9
    ## 101         4         4         4         4         4         4         4
    ## 102         4         4         4         4         4         4         4
    ## 103        13         4         4         4         4         4         4
    ## 104        13         4         4         4         4         4         4
    ## 105         4         4         4         4         4         4         4
    ## 106         4         4         4         4         4         4         4
    ## 107         4         4         4         4         4         4         4
    ## 108         4         4         4         4         4         4         4
    ## 109         2         2         2         2         2         2         2
    ## 110         2         2         2         2         2         2         2
    ## 111         9         9         9         9         9         9         9
    ## 112         4         4         4         4         4         4         4
    ## 113         9         9         9         9         9         9         9
    ## 114         1         1         1         1         1         1         1
    ## 115         9         9         9         9         9         9         9
    ## 116         1         1         1         1         1         1         1
    ## 117         4         4         4         4         4         4         4
    ## 118         1         1         1         1         1         1         1
    ## 119         4         4         4         4         4         4         4
    ## 120         4         4         4         4         4         4         4
    ## 121         4         4         4         4         4         4         4
    ## 122         4         4         4         4         4         4         4
    ## 123         4         4         4         4         4         4         4
    ## 124         4         4         4         4         4         4         4
    ## 125         4         4         4         4         4         4         4
    ## 126         4         4         4         4         4         4         4
    ## 127         4         4         4         4         4         4         4
    ## 128         4         4         4         4         4         4         4
    ## 129         4         4         4         4         4         4         4
    ## 130         4         4         4         4         4         4         4
    ## 131         4         4         4         4         4         4         4
    ## 132         4         4         4         4         4         4         4
    ## 133         4         4         4         4         4         4         4
    ## 134         4         4         4         4         4         4         4
    ## 135         4         4         4         4         4         4         4
    ## 136         4         4         4         4         4         4         4
    ## 137        13         4         4         4         4         4         4
    ## 138         4         4         4         4         4         4         4
    ## 139        13         4         4         4         4         4         4
    ## 140         1         1         1         1         1         1         1
    ## 141         2         2         2         2         2         2         2
    ## 142         1         1         1         1         1         1         1
    ## 143         9         9         9         9         9         9         9
    ## 144         4         4         4         4         4         4         4
    ## 145         9         9         9         9         9         9         9
    ## 146         4         4         4         4         4         4         4
    ## 147         4         4         4         4         4         4         4
    ## 148         4         4         4         4         4         4         4
    ## 149         4         4         4         4         4         4         4
    ## 150         2         2         2         2         2         2         2
    ## 151         1         1         1         1         1         1         1
    ## 152         4         4         4         4         4         4         4
    ## 153         4         4         4         4         4         4         4
    ## 154         4         4         4         4         4         4         4
    ## 155         4         4         4         4         4         4         4
    ## 156         4         4         4         4         4         4         4
    ## 157         4         4         4         4         4         4         4
    ## 158         4         4         4         4         4         4         4
    ## 159         4         4         4         4         4         4         4
    ## 160        12         9         9         9         9         9         9
    ## 161         1         1         1         1         1         1         1
    ## 162         4         4         4         4         4         4         4
    ## 163         4         4         4         4         4         4         4
    ## 164         4         4         4         4         4         4         4
    ## 165         6         6         6         6         6         6         6
    ## 166         6         6         6         6         6         6         6
    ## 167         6         6         6         6         6         6         6
    ## 168         6         6         6         6         6         6         6
    ## 169         9         9         9         9         9         9         9
    ## 170         9         9         9         9         9         9         9
    ## 171         9         9         9         9         9         9         9
    ## 172         9         9         9         9         9         9         9
    ## 173         9         9         9         9         9         9         9
    ## 174         9         9         9         9         9         9         9
    ## 175         9         9         9         9         9         9         9
    ##     clust_1000
    ## 1            1
    ## 2            2
    ## 3            3
    ## 4            4
    ## 5            5
    ## 6            6
    ## 7            4
    ## 8            7
    ## 9            8
    ## 10           9
    ## 11           4
    ## 12           3
    ## 13           6
    ## 14           9
    ## 15           9
    ## 16           9
    ## 17           9
    ## 18           9
    ## 19           9
    ## 20           4
    ## 21           1
    ## 22           1
    ## 23           4
    ## 24           4
    ## 25           4
    ## 26           6
    ## 27           1
    ## 28           1
    ## 29           1
    ## 30           5
    ## 31           1
    ## 32           1
    ## 33           1
    ## 34           1
    ## 35           1
    ## 36           1
    ## 37           6
    ## 38           6
    ## 39           6
    ## 40           9
    ## 41           9
    ## 42           9
    ## 43           9
    ## 44           9
    ## 45           9
    ## 46           9
    ## 47           9
    ## 48           9
    ## 49          10
    ## 50          10
    ## 51           1
    ## 52           4
    ## 53           4
    ## 54           1
    ## 55           1
    ## 56           4
    ## 57           1
    ## 58           1
    ## 59           4
    ## 60           9
    ## 61           9
    ## 62           4
    ## 63           4
    ## 64           9
    ## 65           7
    ## 66           4
    ## 67           4
    ## 68           4
    ## 69           9
    ## 70           4
    ## 71           4
    ## 72           4
    ## 73           4
    ## 74           7
    ## 75           7
    ## 76           4
    ## 77           7
    ## 78           4
    ## 79           9
    ## 80           9
    ## 81           4
    ## 82           9
    ## 83           4
    ## 84           4
    ## 85           4
    ## 86           4
    ## 87           7
    ## 88           4
    ## 89           4
    ## 90           4
    ## 91           4
    ## 92           9
    ## 93           7
    ## 94           4
    ## 95           4
    ## 96           4
    ## 97           4
    ## 98           8
    ## 99           4
    ## 100          9
    ## 101          4
    ## 102          4
    ## 103          4
    ## 104          4
    ## 105          4
    ## 106          4
    ## 107          4
    ## 108          4
    ## 109          2
    ## 110          2
    ## 111          9
    ## 112          4
    ## 113          9
    ## 114          1
    ## 115          9
    ## 116          1
    ## 117          4
    ## 118          1
    ## 119          4
    ## 120          4
    ## 121          4
    ## 122          4
    ## 123          4
    ## 124          4
    ## 125          4
    ## 126          4
    ## 127          4
    ## 128          4
    ## 129          4
    ## 130          4
    ## 131          4
    ## 132          4
    ## 133          4
    ## 134          4
    ## 135          4
    ## 136          4
    ## 137          4
    ## 138          4
    ## 139          4
    ## 140          1
    ## 141          2
    ## 142          1
    ## 143          9
    ## 144          4
    ## 145          9
    ## 146          4
    ## 147          4
    ## 148          4
    ## 149          4
    ## 150          2
    ## 151          1
    ## 152          4
    ## 153          4
    ## 154          4
    ## 155          4
    ## 156          4
    ## 157          4
    ## 158          4
    ## 159          4
    ## 160          9
    ## 161          1
    ## 162          4
    ## 163          4
    ## 164          4
    ## 165          6
    ## 166          6
    ## 167          6
    ## 168          6
    ## 169          9
    ## 170          9
    ## 171          9
    ## 172          9
    ## 173          9
    ## 174          9
    ## 175          9

Let’s now superimpose the clustering information on the previous tree to
examine whether the above code chunk has generated sensible cluster
assignments. Run the code chunk below to insert text labels that span
tree tips assigned to the same clusters at <u>a specified threshold</u>.

> You can update the `target_threshold` variable to examine how cluster
> membership changes in response to clustering distance cutoffs.

``` r
### EDITABLE VARIABLE ###
target_threshold <- 500
#########################

# variable to subset clusters
target_variable <- paste0("clust_", target_threshold)

# create cluster group list object
cluster_grp <- clusters %>% 
  select(ID, target_variable) %>%
  group_by(!!sym(target_variable)) %>% 
  {setNames(group_split(.), group_keys(.)[[1]])} %>% 
  map(~pull(., ID))
# sequester singleton clusters
cluster_grp <- cluster_grp[which(map_dbl(cluster_grp, ~length(.)) > 1)]

# create serovar group list object
serovar_grp <- metadata %>% 
  select(ID, serovar) %>% 
  split(f = as.factor(.$serovar)) %>% 
  map(~pull(., ID))

# add cluster memberships and serovar information
# to tree object
cg_tree <- groupOTU(cg_tree, cluster_grp, 'Clusters')
cg_tree <- groupOTU(cg_tree, serovar_grp, 'Serovars')

# plot core genome tree where
# colored blocks = clusters 
# text annotations = serovars
cg_tree %>% 
  ggtree(layout='circular', # tree shape
         size = 1 # branch width
  ) +
  # add colored blocks to display serovars
  geom_hilight(
    mapping = aes(
      node = node,
      fill = Serovars,
      subset = node %in% map_dbl(
        serovar_grp,
        ~getMRCA(cg_tree, .)
        )
      )
    ) +
  # add text annotations to display clusters
  geom_cladelab(
    mapping = aes(
      node = node,
      label = Clusters,
      subset = node %in% map_dbl(
        cluster_grp,
        ~getMRCA(cg_tree, .)
      )
    ),
    horizontal=T,
    angle = 'auto',
    barsize = 0.75,
    offset = 50,
    offset.text = 50,
    align = T
  ) +
  # legend parameters
  guides(fill = guide_legend(
    nrow = 9,
    override.aes = list(alpha = 0.8)
    )
  ) +
  labs(fill = "Serovar") +
  scale_fill_brewer(palette = "Paired")
```

![](Module_5_Lab_files/figure-markdown_github/cg%20tree%20cluster%20viz-1.png)

## Cluster Analysis

``` r
# NOTE: there needs to be a comma at the end of each line!
serovar_subtree(
  tree = cg_tree,
  serovar_name = NULL, # which serovar cluster to visualize?
  distance_threshold = 25, # the dist threshold used for cluster definition?
  color_by = "outbreak_id.v2", # which metadata variable to color tree tips by?
  color.tiplab = T, # whether to color tip labels
  tip.size = 4, # size of tree tip point
  label_vars = c("geo_loc_v2", "iso_dat_v2", "iso_source", "serovar"), # metadata vars only
  label.offset = 80, # distance between labels and tree tips
  label.size = 5, # tree tip label text size
  legend.x = 0.23, # legend position on x axis
  legend.y = 0.9, # legend position on y axis
  legend.size = 4, # legend text size
  plot.xlim = 2300, # plot area width
  annot.offset = 3, # distance between heatmap and tree tips
  annot.textsize = 5, # heatmap x axis text label size
  annot.barsize = 0.75, # annotation bar width
  show.title = T # whether to display distance threshold
)
```

![](Module_5_Lab_files/figure-markdown_github/serovar%20subtree-1.png)

``` r
ggsave("serovar_subtree.pdf", height = 30, width = 16)
```

``` r
# NOTE: there needs to be a comma at the end of each line!
cluster_subtree(
  tree = cg_tree,
  clusters = clusters,
  distance_threshold = 25, # the dist threshold used for cluster definition?
  cluster_name = "1", # cluster ID to visualize?
  color_by = "outbreak_id.v2", # which metadata variable to color tree tips by?
  color.tiplab = T, # whether to color tip labels
  tip.size = 3, # size of tree tip point
  legend.x = 0.1, # legend position on x axis
  legend.y = 0.85, # legend position on y axis
  legend.size = 5, # legend text size
  plot.xlim = 28, # plot area width
  label_vars = c("geo_loc_v2", "iso_dat_v2", "iso_source"), # metadata vars only
  label.offset = 4.5, # distance between labels and tree tips
  label.size = 4, # tree tip label text size
  annot.offset = 0.1, # distance between heatmap and tree tips
  annot.width = 0.4, # heatmap width
  annot.textsize = 4, # heatmap x axis text label size
  annot.nthreshold = 6 # number of clustering thresholds to display
)
```

    ## Scale for y is already present.
    ## Adding another scale for y, which will replace the existing scale.
    ## Coordinate system already present. Adding new coordinate system, which will
    ## replace the existing one.
    ## Scale for colour is already present.
    ## Adding another scale for colour, which will replace the existing scale.

![](Module_5_Lab_files/figure-markdown_github/cluster%20subtree-1.png)

``` r
# NOTE: there needs to be a comma at the end of each line!
cluster_summary(
  distance_threshold = 10, # the dist threshold used for cluster definition?
  serovar_name = "typhimurium", # which serovar to include?
  vars = c("Country","iso_source", "Plasmids", "serovar"), # metadata vars only
  panel.ncol = 2, # number of columns to arrange the panels in
  rm.low.freq.clust = T # whether to remove low frequency (N < 4) clusters
)
```

    ## PhantomJS not found. You can install it with webshot::install_phantomjs(). If it is installed, please make sure the phantomjs executable can be found via the PATH variable.

<div class="plotly html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-5affc4f25ab85bf888dc" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-5affc4f25ab85bf888dc">{"x":{"data":[{"orientation":"v","width":0.9,"base":0,"x":[1],"y":[13],"text":"cluster: 10<br />count: 13<br />value: USA","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(120,222,216,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"orientation":"v","width":0.9,"base":1,"x":[1],"y":[9],"text":"cluster: 10<br />count:  9<br />value: peanut butter","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(121,178,208,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x2","yaxis":"y","hoverinfo":"text","frame":null},{"orientation":"v","width":0.9,"base":11,"x":[1],"y":[2],"text":"cluster: 10<br />count:  2<br />value: AA372 + AB460","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(124,126,218,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y2","hoverinfo":"text","frame":null},{"orientation":"v","width":0.9,"base":0,"x":[3],"y":[5],"text":"cluster: 26<br />count:  5<br />value: ready to eat food","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(130,234,99,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x2","yaxis":"y","hoverinfo":"text","frame":null},{"orientation":"v","width":0.9,"base":0,"x":[1],"y":[1],"text":"cluster: 10<br />count:  1<br />value: peanut meal","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(135,220,161,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x2","yaxis":"y","hoverinfo":"text","frame":null},{"orientation":"v","width":0.9,"base":10,"x":[1],"y":[1],"text":"cluster: 10<br />count:  1<br />value: organic peanut butter","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(150,61,224,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x2","yaxis":"y","hoverinfo":"text","frame":null},{"orientation":"v","width":0.9,"base":2,"x":[1],"y":[9],"text":"cluster: 10<br />count:  9<br />value: AB460","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(194,172,216,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y2","hoverinfo":"text","frame":null},{"orientation":"v","width":0.9,"base":0,"x":[3],"y":[5],"text":"cluster: 26<br />count:  5<br />value: AB460 + AA163","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(208,162,151,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y2","hoverinfo":"text","frame":null},{"orientation":"v","width":0.9,"base":0,"x":[1],"y":[1],"text":"cluster: 10<br />count:  1<br />value: AB460 + AA372 + AA372","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(212,217,151,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y2","hoverinfo":"text","frame":null},{"orientation":"v","width":0.9,"base":11,"x":[1],"y":[2],"text":"cluster: 10<br />count:  2<br />value: cheese cracker with peanut butter","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(212,221,79,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x2","yaxis":"y","hoverinfo":"text","frame":null},{"orientation":"v","width":0.9,"base":0,"x":[2],"y":[7],"text":"cluster: 23<br />count:  7<br />value: AB460 + AA974","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(213,221,216,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y2","hoverinfo":"text","frame":null},{"orientation":"v","width":0.9,"base":0,"x":[2],"y":[7],"text":"cluster: 23<br />count:  7<br />value: raw-egg mayonnaise","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(218,85,208,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x2","yaxis":"y","hoverinfo":"text","frame":null},{"orientation":"v","width":[0.9,0.9],"base":[0,0],"x":[2,3],"y":[7,5],"text":["cluster: 23<br />count:  7<br />value: AUS","cluster: 26<br />count:  5<br />value: AUS"],"type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(219,97,117,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"orientation":"v","width":0.9,"base":1,"x":[1],"y":[1],"text":"cluster: 10<br />count:  1<br />value: AB460 + AA372","type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(222,141,211,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x","yaxis":"y2","hoverinfo":"text","frame":null},{"orientation":"v","width":[0.9,0.9,0.9],"base":[0,0,0],"x":[1,2,3],"y":[13,7,5],"text":["cluster: 10<br />count: 13<br />value: typhimurium","cluster: 23<br />count:  7<br />value: typhimurium","cluster: 26<br />count:  5<br />value: typhimurium"],"type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(224,162,80,1)","line":{"width":1.88976377952756,"color":"transparent"}},"showlegend":false,"xaxis":"x2","yaxis":"y2","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":37.9178082191781,"r":7.30593607305936,"b":40.1826484018265,"l":37.2602739726027},"plot_bgcolor":"rgba(255,255,255,1)","paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xaxis":{"domain":[0,0.457142857142857],"automargin":true,"type":"linear","autorange":false,"range":[0.4,3.6],"tickmode":"array","ticktext":["10","23","26"],"tickvals":[1,2,3],"categoryorder":"array","categoryarray":["10","23","26"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y2","title":"","hoverformat":".2f"},"annotations":[{"text":"Clusters at T = 10","x":0.5,"y":0,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"top","annotationType":"axis","yshift":-21.9178082191781},{"text":"Count","x":0,"y":0.5,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-90,"xanchor":"right","yanchor":"center","annotationType":"axis","xshift":-21.9178082191781},{"text":"Country","x":0.228571428571429,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.689497716895},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"bottom"},{"text":"iso_source","x":0.771428571428571,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.689497716895},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"bottom"},{"text":"Plasmids","x":0.228571428571429,"y":0.421735159817352,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.689497716895},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"bottom"},{"text":"serovar","x":0.771428571428571,"y":0.421735159817352,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.689497716895},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"bottom"}],"yaxis":{"domain":[0.578264840182648,1],"automargin":true,"type":"linear","autorange":false,"range":[-0.65,13.65],"tickmode":"array","ticktext":["0","5","10"],"tickvals":[0,5,10],"categoryorder":"array","categoryarray":["0","5","10"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":"","hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":"transparent","line":{"color":"rgba(51,51,51,1)","width":0.66417600664176,"linetype":"solid"},"yref":"paper","xref":"paper","x0":0,"x1":0.457142857142857,"y0":0.578264840182648,"y1":1},{"type":"rect","fillcolor":"rgba(217,217,217,1)","line":{"color":"rgba(51,51,51,1)","width":0.66417600664176,"linetype":"solid"},"yref":"paper","xref":"paper","x0":0,"x1":0.457142857142857,"y0":0,"y1":23.37899543379,"yanchor":1,"ysizemode":"pixel"},{"type":"rect","fillcolor":"transparent","line":{"color":"rgba(51,51,51,1)","width":0.66417600664176,"linetype":"solid"},"yref":"paper","xref":"paper","x0":0.542857142857143,"x1":1,"y0":0.578264840182648,"y1":1},{"type":"rect","fillcolor":"rgba(217,217,217,1)","line":{"color":"rgba(51,51,51,1)","width":0.66417600664176,"linetype":"solid"},"yref":"paper","xref":"paper","x0":0.542857142857143,"x1":1,"y0":0,"y1":23.37899543379,"yanchor":1,"ysizemode":"pixel"},{"type":"rect","fillcolor":"transparent","line":{"color":"rgba(51,51,51,1)","width":0.66417600664176,"linetype":"solid"},"yref":"paper","xref":"paper","x0":0,"x1":0.457142857142857,"y0":0,"y1":0.421735159817352},{"type":"rect","fillcolor":"rgba(217,217,217,1)","line":{"color":"rgba(51,51,51,1)","width":0.66417600664176,"linetype":"solid"},"yref":"paper","xref":"paper","x0":0,"x1":0.457142857142857,"y0":0,"y1":23.37899543379,"yanchor":0.421735159817352,"ysizemode":"pixel"},{"type":"rect","fillcolor":"transparent","line":{"color":"rgba(51,51,51,1)","width":0.66417600664176,"linetype":"solid"},"yref":"paper","xref":"paper","x0":0.542857142857143,"x1":1,"y0":0,"y1":0.421735159817352},{"type":"rect","fillcolor":"rgba(217,217,217,1)","line":{"color":"rgba(51,51,51,1)","width":0.66417600664176,"linetype":"solid"},"yref":"paper","xref":"paper","x0":0.542857142857143,"x1":1,"y0":0,"y1":23.37899543379,"yanchor":0.421735159817352,"ysizemode":"pixel"}],"xaxis2":{"type":"linear","autorange":false,"range":[0.4,3.6],"tickmode":"array","ticktext":["10","23","26"],"tickvals":[1,2,3],"categoryorder":"array","categoryarray":["10","23","26"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"domain":[0.542857142857143,1],"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y2","title":"","hoverformat":".2f"},"yaxis2":{"type":"linear","autorange":false,"range":[-0.65,13.65],"tickmode":"array","ticktext":["0","5","10"],"tickvals":[0,5,10],"categoryorder":"array","categoryarray":["0","5","10"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"domain":[0,0.421735159817352],"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":"","hoverformat":".2f"},"showlegend":false,"legend":{"bgcolor":"rgba(255,255,255,1)","bordercolor":"transparent","borderwidth":1.88976377952756,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.689497716895},"title":{"text":"","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"4c741cdd23b6":{"x":{},"y":{},"fill":{},"type":"bar"}},"cur_data":"4c741cdd23b6","visdat":{"4c741cdd23b6":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>

## Investigating Local Core Genes

``` r
# identify a local core genome scheme
# for a target cluster and build tree
local_tree <- local_cg_tree(
  core_mlst = cgmlst_final,
  full_mlst = cgmlst_lc,
  distance_threshold = 100, # the dist threshold used for cluster definition?
  cluster_name = "10", # cluster ID to analyze?
  core_threshold = 1, # minimum number of missing alleles allowed
  method = "nj" # tree method: nj or upgma
)
```

    ## Number of loci before: 2480

    ## Number of loci after: 2695

    ## Number of accessory loci found: 215

    ## Core gene definition: less than 1 missing alleles

``` r
# perform complete linkage clustering
hclust_res_local <- map(dist_cutoff, function(x) {
  cophenetic.phylo(local_tree) %>% 
    as.dist() %>% 
    hclust(method = "complete") %>% 
    cutree(h = x) %>% 
    as.factor()
})
names(hclust_res_local) <- paste0("clust_", dist_cutoff)
# create clusters data frame
clusters_local <- data.frame(hclust_res_local) %>% 
    rownames_to_column("ID")
```

``` r
plot_subtree(
  tree = local_tree,
  clusters = clusters_local,
  color_by = "outbreak_id.v2", # which metadata variable to color tree tips by?
  color.tiplab = T, # whether to color tip labels
  tip.size = 3, # size of tree tip point
  legend.x = 0.15, # legend position on x axis
  legend.y = 0.85, # legend position on y axis
  legend.size = 5, # legend text size
  plot.xlim = 35, # plot area width
  label_vars = c("geo_loc_v2", "iso_dat_v2", "iso_source"), # metadata vars only
  label.offset = 7, # distance between labels and tree tips
  label.size = 4, # tree tip label text size
  annot.offset = 0.1, # distance between heatmap and tree tips
  annot.width = 0.3, # heatmap width
  annot.textsize = 4, # heatmap x axis text label size
  annot.nthreshold = 6 # number of clustering thresholds to display
)
```

    ## Scale for y is already present.
    ## Adding another scale for y, which will replace the existing scale.
    ## Coordinate system already present. Adding new coordinate system, which will
    ## replace the existing one.
    ## Scale for colour is already present.
    ## Adding another scale for colour, which will replace the existing scale.

![](Module_5_Lab_files/figure-markdown_github/plot%20local%20cg%20tree-1.png)

# Group Exercise

1.  Review the cgMLST profiles before and after the removal of low
    quality genomes, and identify two samples that exceed \>1%
    unassigned alleles (i.e. with more than 27 unassigned alleles).

2.  Review the circular tree and identify which serovar(s) is/are not
    monophyletic (i.e. serovars that are distributed in multiple areas
    of the tree).

3.  Use the functions: `serovar_subtree()`, `cluster_subtree()`,
    `cluster_summary()` to analyse one particular serovar and identify
    three clusters that likely correspond to different outbreaks.

4.  Identify genomic clusters that fit the following criteria and
    consider possible scenarios for interpretation of genomic data and
    epidemiological metadata:

    1.  A genomic cluster comprising human clinical cases with similar
        geographical and temporal information

    2.  A genomic cluster in which the human clinical cases are
        dispersed in geography and/or time

    3.  A genomic cluster in which human clinical isolates cluster with
        non-human isolates from a particular source type

    4.  A genomic cluster in which human clinical isolates cluster with
        non-human isolates from multiple source types.

    5.  Genomes from different genomic clusters identified within a
        single putative outbreak that can be linked to a common source

5.  Is it important to analyze clusters at different distance cutoffs?
    Why?

6.  What functional products could be encoded by the accessory loci in
    the data?
